<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุชุญููู ูู ููุชููุจ - ูุณุฎุฉ ูุทูุฑุฉ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <button id="dark-mode-toggle">๐</button>
    <div class="container">
        <h1>ุฃุฏุงุฉ ุชุญููู ููุฏูููุงุช ููุชููุจ ุงููุทูุฑุฉ</h1>
        <p class="subtitle">ุงูุตู ุฑุงุจุท ุงูููุฏูู ุฃุฏูุงู ูุชุญูููู ุจุงูุตูุบุฉ ูุงูุฌูุฏุฉ ุงูุชู ุชูุถููุง</p>
        
        <!-- ุชุจููุจุงุช ุงูููุฒุงุช -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="single">ููุฏูู ูุงุญุฏ</button>
            <button class="tab-btn" data-tab="playlist">ูุงุฆูุฉ ุชุดุบูู</button>
            <button class="tab-btn" data-tab="batch">ุชุญููู ูุชุนุฏุฏ</button>
            <button class="tab-btn" data-tab="settings">ุงูุฅุนุฏุงุฏุงุช</button>
            <button class="tab-btn" data-tab="history">ุงูุชุงุฑูุฎ</button>
        </div>

        <!-- ุชุจููุจ ุงูููุฏูู ุงููุงุญุฏ -->
        <div id="single-tab" class="tab-content active">
            <div class="input-container">
                <input type="text" id="youtube-url" placeholder="https://www.youtube.com/watch?v=...">
                <button id="fetch-btn">ุฌูุจ ูุนูููุงุช ุงูููุฏูู</button>
            </div>
        </div>

        <!-- ุชุจููุจ ูุงุฆูุฉ ุงูุชุดุบูู -->
        <div id="playlist-tab" class="tab-content">
            <div class="playlist-container">
                <div class="input-container">
                    <input type="text" id="playlist-url" placeholder="https://www.youtube.com/playlist?list=...">
                    <button id="playlist-fetch-btn">ุฌูุจ ูุนูููุงุช ูุงุฆูุฉ ุงูุชุดุบูู</button>
                </div>
                <div id="playlist-info" class="playlist-info" style="display: none;"></div>
                <div id="playlist-videos" class="playlist-videos" style="display: none;"></div>
            </div>
        </div>

        <!-- ุชุจููุจ ุงูุชุญููู ุงููุชุนุฏุฏ -->
        <div id="batch-tab" class="tab-content">
            <div class="batch-container">
                <textarea id="batch-urls" placeholder="ุงูุตู ุนุฏุฉ ุฑูุงุจุท ููุชููุจุ ูู ุฑุงุจุท ูู ุณุทุฑ ูููุตู..."></textarea>
                <button id="batch-fetch-btn">ุฌูุจ ูุนูููุงุช ุฌููุน ุงูููุฏูููุงุช</button>
            </div>
            <div id="batch-results" class="batch-results" style="display: none;"></div>
        </div>

        <!-- ุชุจููุจ ุงูุฅุนุฏุงุฏุงุช -->
        <div id="settings-tab" class="tab-content">
            <div id="settings-container">
                <h3>ุงูุฅุนุฏุงุฏุงุช ุงููุชูุฏูุฉ</h3>
                
                <div class="settings-section">
                    <h4>ุฅุนุฏุงุฏุงุช ุงูุชุญููู</h4>
                    <div class="setting-item">
                        <label for="max-concurrent">ุนุฏุฏ ุงูุชุญูููุงุช ุงููุชุฒุงููุฉ:</label>
                        <input type="number" id="max-concurrent" min="1" max="5" value="2">
                        <small>ุนุฏุฏ ุงูููุฏูููุงุช ุงูุชู ูููู ุชุญููููุง ูู ููุณ ุงูููุช</small>
                    </div>
                    
                    <div class="setting-item">
                        <label for="default-quality">ุงูุฌูุฏุฉ ุงูุงูุชุฑุงุถูุฉ:</label>
                        <select id="default-quality">
                            <option value="best">ุฃูุถู ุฌูุฏุฉ</option>
                            <option value="720p">720p</option>
                            <option value="480p">480p</option>
                            <option value="360p">360p</option>
                            <option value="audio">ุตูุช ููุท</option>
                        </select>
                    </div>
                    
                    <div class="setting-item">
                        <label for="download-path">ูุณุงุฑ ุงูุชุญููู:</label>
                        <input type="text" id="download-path" placeholder="ูุฌูุฏ ุงูุชุญูููุงุช ุงูุงูุชุฑุงุถู">
                        <button id="browse-path">ุชุตูุญ</button>
                    </div>
                </div>

                <div class="settings-section">
                    <h4>ุฅุนุฏุงุฏุงุช ุงููุงุฌูุฉ</h4>
                    <div class="setting-item">
                        <label>
                            <input type="checkbox" id="auto-dark-mode"> ุชูุนูู ุงููุถุน ุงููููู ุชููุงุฆูุงู
                        </label>
                    </div>
                    
                    <div class="setting-item">
                        <label>
                            <input type="checkbox" id="show-notifications" checked> ุฅุธูุงุฑ ุงูุฅุดุนุงุฑุงุช
                        </label>
                    </div>
                    
                    <div class="setting-item">
                        <label>
                            <input type="checkbox" id="save-history" checked> ุญูุธ ุชุงุฑูุฎ ุงูุชุญูููุงุช
                        </label>
                    </div>
                </div>

                <div class="settings-section">
                    <h4>ุฅุนุฏุงุฏุงุช ูุชูุฏูุฉ</h4>
                    <div class="setting-item">
                        <label for="user-agent">User Agent:</label>
                        <input type="text" id="user-agent" placeholder="ูุชุตูุญ ุงูุชุฑุงุถู">
                    </div>
                    
                    <div class="setting-item">
                        <label for="proxy">ุงูุจุฑููุณู (ุงุฎุชูุงุฑู):</label>
                        <input type="text" id="proxy" placeholder="http://proxy:port">
                    </div>
                </div>

                <div class="settings-actions">
                    <button id="save-settings" class="btn-primary">ุญูุธ ุงูุฅุนุฏุงุฏุงุช</button>
                    <button id="reset-settings" class="btn-secondary">ุฅุนุงุฏุฉ ุชุนููู</button>
                    <button id="export-settings" class="btn-secondary">ุชุตุฏูุฑ ุงูุฅุนุฏุงุฏุงุช</button>
                    <button id="import-settings" class="btn-secondary">ุงุณุชูุฑุงุฏ ุงูุฅุนุฏุงุฏุงุช</button>
                </div>
            </div>
        </div>

        <!-- ุชุจููุจ ุงูุชุงุฑูุฎ -->
        <div id="history-tab" class="tab-content">
            <div id="history-container">
                <h3>ุชุงุฑูุฎ ุงูุชุญูููุงุช</h3>
                <button id="refresh-history">ุชุญุฏูุซ</button>
                <button id="clear-history" class="btn-danger">ูุณุญ ุงูุชุงุฑูุฎ</button>
                <button id="health-check" class="btn-secondary">ูุญุต ุงูุชุทุจูู</button>
                <div id="history-list"></div>
            </div>
        </div>

        <!-- ุดุฑูุท ุงูุชูุฏู -->
        <div id="progress-container" class="progress-container" style="display: none;">
            <h3>ุชูุฏู ุงูุชุญููู</h3>
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill"></div>
            </div>
            <div id="progress-text" class="progress-text">0%</div>
            <div id="progress-message" class="progress-message"></div>
        </div>

        <!-- ุงูุชุญูููุงุช ุงููุดุทุฉ -->
        <div id="active-downloads" class="active-downloads" style="display: none;">
            <h3>ุงูุชุญูููุงุช ุงููุดุทุฉ</h3>
            <div id="downloads-list"></div>
        </div>

        <div id="loader" class="loader" style="display: none;"></div>
        <div id="error-message" class="error-message" style="display: none;"></div>
        
        <div id="video-info-container" class="video-info-container" style="display: none;">
            <div class="thumbnail">
                <img id="video-thumbnail" src="" alt="ุตูุฑุฉ ุงูููุฏูู ุงููุตุบุฑุฉ">
            </div>
            <div class="details">
                <h2 id="video-title"></h2>
                <p><strong>ุงููุฏุฉ:</strong> <span id="video-duration"></span></p>
                
                <div class="download-options">
                    
                    <!-- ูุณู ุงูููุฏูู ูุน ุงูุตูุช -->
                    <div id="video-audio-section">
                        <h3><span class="icon">๐ฌ</span> ููุฏูู + ุตูุช (ุฌูุฏุฉ ุนุงุฏูุฉ)</h3>
                        <div id="video-audio-streams" class="streams-grid"></div>
                    </div>

                    <!-- ูุณู ุงูููุฏูู ููุท -->
                    <div id="video-only-section">
                        <h3><span class="icon">๐ผ๏ธ</span> ููุฏูู ููุท (ุฌูุฏุฉ ุนุงููุฉ - ุจุฏูู ุตูุช)</h3>
                        <p class="note">ููุงุญุธุฉ: ูุฐู ุงูุตูุบ ููุงุณุจุฉ ูููููุชุงุฌุ ูุง ุชุญุชูู ุนูู ุตูุช.</p>
                        <div id="video-only-streams" class="streams-grid"></div>
                    </div>
                    
                    <!-- ูุณู ุงูุตูุช ููุท -->
                    <div id="audio-only-section">
                        <h3><span class="icon">๐ต</span> ุตูุช ููุท</h3>
                        <div id="audio-only-streams" class="streams-grid"></div>
                    </div>

                </div>
            </div>
        </div>

    </div>

    <script>
        const fetchBtn = document.getElementById('fetch-btn');
        const urlInput = document.getElementById('youtube-url');
        const loader = document.getElementById('loader');
        const videoInfoContainer = document.getElementById('video-info-container');
        const errorMessage = document.getElementById('error-message');
        const darkModeToggle = document.getElementById('dark-mode-toggle');

        let currentVideoTitle = '';
        let currentVideoUrl = '';
        let activeDownloads = new Map();
        let progressInterval = null;

        // --- ููุทู ุงููุถุน ุงููููู ---
        if (localStorage.getItem('darkMode') === 'enabled') {
            document.body.classList.add('dark-mode');
            darkModeToggle.textContent = 'โ๏ธ';
        }

        darkModeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            if (document.body.classList.contains('dark-mode')) {
                localStorage.setItem('darkMode', 'enabled');
                darkModeToggle.textContent = 'โ๏ธ';
            } else {
                localStorage.setItem('darkMode', 'disabled');
                darkModeToggle.textContent = '๐';
            }
        });
        // -------------------------

        // --- ููุทู ุงูุชุจููุจุงุช ---
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.dataset.tab;
                
                // ุฅุฎูุงุก ุฌููุน ุงููุญุชููุงุช
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // ุฅุฒุงูุฉ ุงููุดุท ูู ุฌููุน ุงูุฃุฒุฑุงุฑ
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('active');
                });
                
                // ุฅุธูุงุฑ ุงููุญุชูู ุงููุทููุจ
                document.getElementById(tabName + '-tab').classList.add('active');
                btn.classList.add('active');
                
                // ุชุญุฏูุซ ุงูุชุงุฑูุฎ ุนูุฏ ุงูุงูุชูุงู ุฅููู
                if (tabName === 'history') {
                    loadHistory();
                }
            });
        });

        // --- ูุงุฆูุฉ ุงูุชุดุบูู ---
        document.getElementById('playlist-fetch-btn').addEventListener('click', async () => {
            const url = document.getElementById('playlist-url').value.trim();
            if (!url) {
                showError('ุงูุฑุฌุงุก ุฅุฏุฎุงู ุฑุงุจุท ูุงุฆูุฉ ุงูุชุดุบูู.');
                return;
            }

            try {
                const response = await fetch('/playlist_info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url })
                });

                const data = await response.json();
                if (response.ok) {
                    displayPlaylistInfo(data);
                } else {
                    showError(data.error || 'ูุดู ูู ุฌูุจ ูุนูููุงุช ูุงุฆูุฉ ุงูุชุดุบูู.');
                }
            } catch (error) {
                showError('ูุดู ุงูุงุชุตุงู ุจุงูุฎุงุฏู.');
            }
        });

        function displayPlaylistInfo(data) {
            const infoContainer = document.getElementById('playlist-info');
            const videosContainer = document.getElementById('playlist-videos');
            
            infoContainer.style.display = 'block';
            videosContainer.style.display = 'block';
            
            infoContainer.innerHTML = `
                <h3>${data.playlist_title}</h3>
                <p><strong>ุนุฏุฏ ุงูููุฏูููุงุช:</strong> ${data.total_videos}</p>
                <button id="download-all-playlist" class="download-all-btn">ุชุญููู ุฌููุน ุงูููุฏูููุงุช</button>
            `;
            
            videosContainer.innerHTML = '';
            data.videos.forEach((video, index) => {
                const videoItem = document.createElement('div');
                videoItem.className = 'playlist-video-item';
                videoItem.innerHTML = `
                    <div class="video-thumbnail-small">
                        <img src="${video.thumbnail}" alt="ุตูุฑุฉ ูุตุบุฑุฉ" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjkwIiB2aWV3Qm94PSIwIDAgMTIwIDkwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iOTAiIGZpbGw9IiNlZWUiLz48dGV4dCB4PSI2MCIgeT0iNDUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMiIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+ูุง ุชูุฌุฏ ุตูุฑุฉ</dGV4dD48L3N2Zz4='">
                    </div>
                    <div class="video-info-small">
                        <h4>${video.title}</h4>
                        <p>ุงููุฏุฉ: ${formatDuration(video.duration)}</p>
                        <button class="btn-small" onclick="downloadSingleFromPlaylist('${video.url}', '${video.title}')">ุชุญููู</button>
                    </div>
                `;
                videosContainer.appendChild(videoItem);
            });
            
            // ุฅุถุงูุฉ ูุณุชูุน ูุชุญููู ุฌููุน ุงูููุฏูููุงุช
            document.getElementById('download-all-playlist').addEventListener('click', () => {
                const urls = data.videos.map(video => video.url);
                downloadPlaylistBatch(urls);
            });
        }

        function formatDuration(seconds) {
            if (!seconds || seconds === 0) return 'ุบูุฑ ูุนุฑูู';
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function downloadSingleFromPlaylist(url, title) {
            // ูุชุญ ุตูุญุฉ ุฌุฏูุฏุฉ ูุชุญููู ุงูููุฏูู ุงููุฑุฏู
            window.open(`/?url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}`, '_blank');
        }

        function downloadPlaylistBatch(urls) {
            // ุจุฏุก ุชุญููู ูุชุนุฏุฏ ูููุงุฆูุฉ
            fetch('/batch_download', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ urls: urls })
            })
            .then(response => response.json())
            .then(data => {
                if (data.batch_id) {
                    startProgressTracking(data.batch_id);
                    showNotification(`ุชู ุจุฏุก ุชุญููู ${urls.length} ููุฏูู ูู ุงููุงุฆูุฉ`, 'info');
                }
            })
            .catch(error => {
                showError('ูุดู ูู ุจุฏุก ุงูุชุญููู ุงููุชุนุฏุฏ');
            });
        }

        // --- ุงูุชุญููู ุงููุชุนุฏุฏ ---
        document.getElementById('batch-fetch-btn').addEventListener('click', async () => {
            const urlsText = document.getElementById('batch-urls').value.trim();
            if (!urlsText) {
                showError('ุงูุฑุฌุงุก ุฅุฏุฎุงู ุฑูุงุจุท ููุชููุจ.');
                return;
            }

            const urls = urlsText.split('\n').filter(url => url.trim());
            if (urls.length === 0) {
                showError('ูุง ุชูุฌุฏ ุฑูุงุจุท ุตุงูุญุฉ.');
                return;
            }

            try {
                const response = await fetch('/batch_download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ urls: urls })
                });

                const data = await response.json();
                if (response.ok) {
                    startProgressTracking(data.batch_id);
                    showBatchResults(data);
                } else {
                    showError(data.error || 'ุญุฏุซ ุฎุทุฃ ูู ุงูุชุญููู ุงููุชุนุฏุฏ.');
                }
            } catch (error) {
                showError('ูุดู ุงูุงุชุตุงู ุจุงูุฎุงุฏู.');
            }
        });

        // --- ุงูุฅุนุฏุงุฏุงุช ---
        document.getElementById('save-settings').addEventListener('click', saveSettings);
        document.getElementById('reset-settings').addEventListener('click', resetSettings);
        document.getElementById('export-settings').addEventListener('click', exportSettings);
        document.getElementById('import-settings').addEventListener('click', importSettings);
        
        // ุชุญููู ุงูุฅุนุฏุงุฏุงุช ุนูุฏ ูุชุญ ุงูุชุจููุจ
        document.querySelector('[data-tab="settings"]').addEventListener('click', loadSettings);

        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('appSettings') || '{}');
            
            document.getElementById('max-concurrent').value = settings.maxConcurrent || 2;
            document.getElementById('default-quality').value = settings.defaultQuality || 'best';
            document.getElementById('download-path').value = settings.downloadPath || '';
            document.getElementById('auto-dark-mode').checked = settings.autoDarkMode || false;
            document.getElementById('show-notifications').checked = settings.showNotifications !== false;
            document.getElementById('save-history').checked = settings.saveHistory !== false;
            document.getElementById('user-agent').value = settings.userAgent || '';
            document.getElementById('proxy').value = settings.proxy || '';
        }

        function saveSettings() {
            const settings = {
                maxConcurrent: parseInt(document.getElementById('max-concurrent').value),
                defaultQuality: document.getElementById('default-quality').value,
                downloadPath: document.getElementById('download-path').value,
                autoDarkMode: document.getElementById('auto-dark-mode').checked,
                showNotifications: document.getElementById('show-notifications').checked,
                saveHistory: document.getElementById('save-history').checked,
                userAgent: document.getElementById('user-agent').value,
                proxy: document.getElementById('proxy').value
            };
            
            localStorage.setItem('appSettings', JSON.stringify(settings));
            showNotification('ุชู ุญูุธ ุงูุฅุนุฏุงุฏุงุช ุจูุฌุงุญ!', 'success');
        }

        function resetSettings() {
            if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุฅุนุงุฏุฉ ุชุนููู ุฌููุน ุงูุฅุนุฏุงุฏุงุชุ')) {
                localStorage.removeItem('appSettings');
                loadSettings();
                showNotification('ุชู ุฅุนุงุฏุฉ ุชุนููู ุงูุฅุนุฏุงุฏุงุช', 'info');
            }
        }

        function exportSettings() {
            const settings = localStorage.getItem('appSettings') || '{}';
            const blob = new Blob([settings], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'youtube-downloader-settings.json';
            a.click();
            URL.revokeObjectURL(url);
            showNotification('ุชู ุชุตุฏูุฑ ุงูุฅุนุฏุงุฏุงุช', 'success');
        }

        function importSettings() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const settings = JSON.parse(e.target.result);
                            localStorage.setItem('appSettings', JSON.stringify(settings));
                            loadSettings();
                            showNotification('ุชู ุงุณุชูุฑุงุฏ ุงูุฅุนุฏุงุฏุงุช ุจูุฌุงุญ!', 'success');
                        } catch (error) {
                            showError('ุฎุทุฃ ูู ููู ุงูุฅุนุฏุงุฏุงุช');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // --- ุชุญุฏูุซ ุงูุชุงุฑูุฎ ---
        document.getElementById('refresh-history').addEventListener('click', loadHistory);
        document.getElementById('clear-history').addEventListener('click', clearHistory);
        document.getElementById('health-check').addEventListener('click', performHealthCheck);

        function clearHistory() {
            if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ูุณุญ ุชุงุฑูุฎ ุงูุชุญูููุงุชุ')) {
                fetch('/clear_history', { method: 'POST' })
                    .then(() => {
                        loadHistory();
                        showNotification('ุชู ูุณุญ ุงูุชุงุฑูุฎ', 'info');
                    })
                    .catch(error => {
                        showError('ูุดู ูู ูุณุญ ุงูุชุงุฑูุฎ');
                    });
            }
        }

        function performHealthCheck() {
            fetch('/health')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'healthy') {
                        showNotification(`โ ${data.message} - yt-dlp: ${data.yt_dlp_version}`, 'success');
                    } else {
                        showError(`โ ${data.message}`);
                    }
                })
                .catch(error => {
                    showError('ูุดู ูู ูุญุต ุงูุชุทุจูู');
                });
        }

        function loadHistory() {
            fetch('/history')
                .then(response => response.json())
                .then(history => {
                    displayHistory(history);
                })
                .catch(error => {
                    console.error('Error loading history:', error);
                });
        }

        function displayHistory(history) {
            const container = document.getElementById('history-list');
            container.innerHTML = '';

            if (history.length === 0) {
                container.innerHTML = '<p class="note">ูุง ููุฌุฏ ุชุงุฑูุฎ ุชุญูููุงุช.</p>';
                return;
            }

            history.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div class="history-info">
                        <h4>${item.title}</h4>
                        <p><strong>ุงูุฌูุฏุฉ:</strong> ${item.quality}</p>
                        <p><strong>ุงูุชุงุฑูุฎ:</strong> ${new Date(item.timestamp).toLocaleString('ar-SA')}</p>
                        <p><strong>ุงูุญุฌู:</strong> ${(item.size / 1024 / 1024).toFixed(2)} MB</p>
                    </div>
                    <div class="history-actions">
                        <button class="btn-small" onclick="window.open('${item.url}', '_blank')">ุนุฑุถ ุงูููุฏูู</button>
                    </div>
                `;
                container.appendChild(historyItem);
            });
        }

        function showBatchResults(data) {
            const container = document.getElementById('batch-results');
            container.style.display = 'block';
            container.innerHTML = `
                <h3>ูุชุงุฆุฌ ุงูุชุญููู ุงููุชุนุฏุฏ</h3>
                <p>ุชู ุจุฏุก ุชุญููู ${data.total} ููุฏูู</p>
                <div id="batch-progress"></div>
            `;
        }

        function startProgressTracking(downloadId) {
            if (progressInterval) {
                clearInterval(progressInterval);
            }

            progressInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/progress/${downloadId}`);
                    const progress = await response.json();
                    
                    updateProgressBar(progress);
                    
                    if (progress.status === 'completed' || progress.status === 'error') {
                        clearInterval(progressInterval);
                        if (progress.status === 'completed') {
                            showNotification('ุชู ุงูุชุญููู ุจูุฌุงุญ!', 'success');
                        } else {
                            showError(progress.message);
                        }
                    }
                } catch (error) {
                    console.error('Error tracking progress:', error);
                }
            }, 1000);
        }

        function updateProgressBar(progress) {
            const container = document.getElementById('progress-container');
            const fill = document.getElementById('progress-fill');
            const text = document.getElementById('progress-text');
            const message = document.getElementById('progress-message');

            container.style.display = 'block';
            fill.style.width = progress.progress + '%';
            text.textContent = progress.progress + '%';
            message.textContent = progress.message;
        }

        function showNotification(message, type = 'info') {
            // ุฅูุดุงุก ุฅุดุนุงุฑ
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        fetchBtn.addEventListener('click', async () => {
            const url = urlInput.value.trim();
            if (!url) {
                showError('ุงูุฑุฌุงุก ุฅุฏุฎุงู ุฑุงุจุท ููุชููุจ.');
                return;
            }

            videoInfoContainer.style.display = 'none';
            errorMessage.style.display = 'none';
            loader.style.display = 'block';

            try {
                const response = await fetch('/get_video_info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url }),
                });

                const data = await response.json();
                loader.style.display = 'none';

                if (response.ok) {
                    displayVideoInfo(data, url);
                } else {
                    showError(data.error || 'ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุนุฑูู.');
                }

            } catch (error) {
                showError('ูุดู ุงูุงุชุตุงู ุจุงูุฎุงุฏู. ุงูุฑุฌุงุก ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
                loader.style.display = 'none';
            }
        });

        function displayVideoInfo(data, videoUrl) {
            currentVideoUrl = videoUrl;
            currentVideoTitle = data.video_info.title;

            document.getElementById('video-thumbnail').src = data.video_info.thumbnail_url;
            document.getElementById('video-title').textContent = data.video_info.title;
            document.getElementById('video-duration').textContent = data.video_info.duration;

            const { video_audio, video_only, audio_only } = data.streams;

            populateStreams('video-audio-streams', video_audio, false);
            populateStreams('video-only-streams', video_only, false);
            populateStreams('audio-only-streams', audio_only, true);

            document.getElementById('video-audio-section').style.display = video_audio.length > 0 ? 'block' : 'none';
            document.getElementById('video-only-section').style.display = video_only.length > 0 ? 'block' : 'none';
            document.getElementById('audio-only-section').style.display = audio_only.length > 0 ? 'block' : 'none';

            videoInfoContainer.style.display = 'flex';
        }

        function populateStreams(containerId, streams, isAudio) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            if (streams.length > 0) {
                streams.forEach(stream => {
                    const text = isAudio ?
                        `${stream.ext.toUpperCase()} - ${stream.filesize}` :
                        `${stream.resolution} (${stream.ext.toUpperCase()}) - ${stream.filesize}`;
                    const downloadLink = createDownloadButton(stream.itag, text, isAudio);
                    container.appendChild(downloadLink);
                });
            } else {
                container.innerHTML = '<p class="note">ูุง ุชูุฌุฏ ุฎูุงุฑุงุช ูุชุงุญุฉ ูู ูุฐู ุงููุฆุฉ.</p>';
            }
        }
        
        function createDownloadButton(itag, text, isAudio) {
            const button = document.createElement('a');
            button.className = 'download-btn';
            const downloadId = generateDownloadId();
            let href = `/download?url=${encodeURIComponent(currentVideoUrl)}&itag=${itag}&title=${encodeURIComponent(currentVideoTitle)}&download_id=${downloadId}`;
            if (isAudio) {
                href += '&is_audio=true';
            }
            
            button.href = href;
            button.textContent = text;
            button.target = '_blank';
            
            // ุฅุถุงูุฉ ุชุชุจุน ุงูุชูุฏู
            button.addEventListener('click', () => {
                startProgressTracking(downloadId);
                addToActiveDownloads(downloadId, currentVideoTitle, text);
            });
            
            return button;
        }

        function generateDownloadId() {
            return 'download_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function addToActiveDownloads(downloadId, title, quality) {
            const container = document.getElementById('active-downloads');
            const list = document.getElementById('downloads-list');
            
            container.style.display = 'block';
            
            const downloadItem = document.createElement('div');
            downloadItem.className = 'download-item';
            downloadItem.id = `download-${downloadId}`;
            downloadItem.innerHTML = `
                <div class="download-info">
                    <h4>${title}</h4>
                    <p>${quality}</p>
                </div>
                <div class="download-status">
                    <div class="mini-progress-bar">
                        <div class="mini-progress-fill" id="mini-progress-${downloadId}"></div>
                    </div>
                    <span class="download-percentage" id="mini-percentage-${downloadId}">0%</span>
                </div>
            `;
            
            list.appendChild(downloadItem);
            activeDownloads.set(downloadId, downloadItem);
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            videoInfoContainer.style.display = 'none';
        }
    </script>

</body>
</html>

