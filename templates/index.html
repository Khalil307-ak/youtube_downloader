<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ­Ù…ÙŠÙ„ Ù…Ù† ÙŠÙˆØªÙŠÙˆØ¨ - Ù†Ø³Ø®Ø© Ù…Ø·ÙˆØ±Ø©</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <button id="dark-mode-toggle">ğŸŒ™</button>
    <div class="container">
        <h1>Ø£Ø¯Ø§Ø© ØªØ­Ù…ÙŠÙ„ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ÙŠÙˆØªÙŠÙˆØ¨ Ø§Ù„Ù…Ø·ÙˆØ±Ø©</h1>
        <p class="subtitle">Ø§Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø£Ø¯Ù†Ø§Ù‡ Ù„ØªØ­Ù…ÙŠÙ„Ù‡ Ø¨Ø§Ù„ØµÙŠØºØ© ÙˆØ§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„ØªÙŠ ØªÙØ¶Ù„Ù‡Ø§</p>
        
        <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù…ÙŠØ²Ø§Øª -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="single">ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ø­Ø¯</button>
            <button class="tab-btn" data-tab="playlist">Ù‚Ø§Ø¦Ù…Ø© ØªØ´ØºÙŠÙ„</button>
            <button class="tab-btn" data-tab="batch">ØªØ­Ù…ÙŠÙ„ Ù…ØªØ¹Ø¯Ø¯</button>
            <button class="tab-btn" data-tab="settings">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
            <button class="tab-btn" data-tab="history">Ø§Ù„ØªØ§Ø±ÙŠØ®</button>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ÙˆØ§Ø­Ø¯ -->
        <div id="single-tab" class="tab-content active">
            <div class="input-container">
                <input type="text" id="youtube-url" placeholder="https://www.youtube.com/watch?v=...">
                <button id="fetch-btn">Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</button>
            </div>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ -->
        <div id="playlist-tab" class="tab-content">
            <div class="playlist-container">
                <div class="input-container">
                    <input type="text" id="playlist-url" placeholder="https://www.youtube.com/playlist?list=...">
                    <button id="playlist-fetch-btn">Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ´ØºÙŠÙ„</button>
                </div>
                <div id="playlist-info" class="playlist-info" style="display: none;"></div>
                <div id="playlist-videos" class="playlist-videos" style="display: none;"></div>
            </div>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ -->
        <div id="batch-tab" class="tab-content">
            <div class="batch-container">
                <textarea id="batch-urls" placeholder="Ø§Ù„ØµÙ‚ Ø¹Ø¯Ø© Ø±ÙˆØ§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨ØŒ ÙƒÙ„ Ø±Ø§Ø¨Ø· ÙÙŠ Ø³Ø·Ø± Ù…Ù†ÙØµÙ„..."></textarea>
                <button id="batch-fetch-btn">Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</button>
            </div>
            <div id="batch-results" class="batch-results" style="display: none;"></div>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
        <div id="settings-tab" class="tab-content">
            <div id="settings-container">
                <h3>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h3>
                
                <div class="settings-section">
                    <h4>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„</h4>
                    <div class="setting-item">
                        <label for="max-concurrent">Ø¹Ø¯Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†Ø©:</label>
                        <input type="number" id="max-concurrent" min="1" max="5" value="2">
                        <small>Ø¹Ø¯Ø¯ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„ØªÙŠ ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„Ù‡Ø§ ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª</small>
                    </div>
                    
                    <div class="setting-item">
                        <label for="default-quality">Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©:</label>
                        <select id="default-quality">
                            <option value="best">Ø£ÙØ¶Ù„ Ø¬ÙˆØ¯Ø©</option>
                            <option value="720p">720p</option>
                            <option value="480p">480p</option>
                            <option value="360p">360p</option>
                            <option value="audio">ØµÙˆØª ÙÙ‚Ø·</option>
                        </select>
                    </div>
                    
                    <div class="setting-item">
                        <label for="download-path">Ù…Ø³Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„:</label>
                        <input type="text" id="download-path" placeholder="Ù…Ø¬Ù„Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ">
                        <button id="browse-path">ØªØµÙØ­</button>
                    </div>
                </div>

                <div class="settings-section">
                    <h4>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©</h4>
                    <div class="setting-item">
                        <label>
                            <input type="checkbox" id="auto-dark-mode"> ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                        </label>
                    </div>
                    
                    <div class="setting-item">
                        <label>
                            <input type="checkbox" id="show-notifications" checked> Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
                        </label>
                    </div>
                    
                    <div class="setting-item">
                        <label>
                            <input type="checkbox" id="save-history" checked> Ø­ÙØ¸ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª
                        </label>
                    </div>
                </div>

                <div class="settings-section">
                    <h4>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©</h4>
                    <div class="setting-item">
                        <label for="user-agent">User Agent:</label>
                        <input type="text" id="user-agent" placeholder="Ù…ØªØµÙØ­ Ø§ÙØªØ±Ø§Ø¶ÙŠ">
                    </div>
                    
                    <div class="setting-item">
                        <label for="proxy">Ø§Ù„Ø¨Ø±ÙˆÙƒØ³ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                        <input type="text" id="proxy" placeholder="http://proxy:port">
                    </div>
                </div>

                <div class="settings-actions">
                    <button id="save-settings" class="btn-primary">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                    <button id="reset-settings" class="btn-secondary">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
                    <button id="export-settings" class="btn-secondary">ØªØµØ¯ÙŠØ± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                    <button id="import-settings" class="btn-secondary">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                </div>
            </div>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªØ§Ø±ÙŠØ® -->
        <div id="history-tab" class="tab-content">
            <div id="history-container">
                <h3>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª</h3>
                <button id="refresh-history">ØªØ­Ø¯ÙŠØ«</button>
                <button id="clear-history" class="btn-danger">Ù…Ø³Ø­ Ø§Ù„ØªØ§Ø±ÙŠØ®</button>
                <button id="health-check" class="btn-secondary">ÙØ­Øµ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>
                <div id="history-list"></div>
            </div>
        </div>

        <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… -->
        <div id="progress-container" class="progress-container" style="display: none;">
            <h3>ØªÙ‚Ø¯Ù… Ø§Ù„ØªØ­Ù…ÙŠÙ„</h3>
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill"></div>
            </div>
            <div id="progress-text" class="progress-text">0%</div>
            <div id="progress-message" class="progress-message"></div>
        </div>

        <!-- Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© -->
        <div id="active-downloads" class="active-downloads" style="display: none;">
            <h3>Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</h3>
            <div id="downloads-list"></div>
        </div>

        <div id="loader" class="loader" style="display: none;"></div>
        <div id="error-message" class="error-message" style="display: none;"></div>
        
        <div id="video-info-container" class="video-info-container" style="display: none;">
            <div class="thumbnail">
                <img id="video-thumbnail" src="" alt="ØµÙˆØ±Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…ØµØºØ±Ø©">
            </div>
            <div class="details">
                <h2 id="video-title"></h2>
                <p><strong>Ø§Ù„Ù…Ø¯Ø©:</strong> <span id="video-duration"></span></p>
                
                <div class="download-options">
                    
                    <!-- Ù‚Ø³Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ø¹ Ø§Ù„ØµÙˆØª -->
                    <div id="video-audio-section">
                        <h3><span class="icon">ğŸ¬</span> ÙÙŠØ¯ÙŠÙˆ + ØµÙˆØª (Ø¬ÙˆØ¯Ø© Ø¹Ø§Ø¯ÙŠØ©)</h3>
                        <div id="video-audio-streams" class="streams-grid"></div>
                    </div>

                    <!-- Ù‚Ø³Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙ‚Ø· -->
                    <div id="video-only-section">
                        <h3><span class="icon">ğŸ–¼ï¸</span> ÙÙŠØ¯ÙŠÙˆ ÙÙ‚Ø· (Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ© - Ø¨Ø¯ÙˆÙ† ØµÙˆØª)</h3>
                        <p class="note">Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ù‡ Ø§Ù„ØµÙŠØº Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ù…ÙˆÙ†ØªØ§Ø¬ØŒ Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ØµÙˆØª.</p>
                        <div id="video-only-streams" class="streams-grid"></div>
                    </div>
                    
                    <!-- Ù‚Ø³Ù… Ø§Ù„ØµÙˆØª ÙÙ‚Ø· -->
                    <div id="audio-only-section">
                        <h3><span class="icon">ğŸµ</span> ØµÙˆØª ÙÙ‚Ø·</h3>
                        <div id="audio-only-streams" class="streams-grid"></div>
                    </div>

                </div>
            </div>
        </div>

    </div>

    <script>
        const fetchBtn = document.getElementById('fetch-btn');
        const urlInput = document.getElementById('youtube-url');
        const loader = document.getElementById('loader');
        const videoInfoContainer = document.getElementById('video-info-container');
        const errorMessage = document.getElementById('error-message');
        const darkModeToggle = document.getElementById('dark-mode-toggle');

        let currentVideoTitle = '';
        let currentVideoUrl = '';
        let activeDownloads = new Map();
        let progressInterval = null;

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ ---
        if (localStorage.getItem('darkMode') === 'enabled') {
            document.body.classList.add('dark-mode');
            darkModeToggle.textContent = 'â˜€ï¸';
        }

        darkModeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            if (document.body.classList.contains('dark-mode')) {
                localStorage.setItem('darkMode', 'enabled');
                darkModeToggle.textContent = 'â˜€ï¸';
            } else {
                localStorage.setItem('darkMode', 'disabled');
                darkModeToggle.textContent = 'ğŸŒ™';
            }
        });
        // -------------------------

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ---
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.dataset.tab;
                
                // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙŠØ§Øª
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø· Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('active');
                });
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
                document.getElementById(tabName + '-tab').classList.add('active');
                btn.classList.add('active');
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„ÙŠÙ‡
                if (tabName === 'history') {
                    loadHistory();
                }
            });
        });

        // --- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ ---
        document.getElementById('playlist-fetch-btn').addEventListener('click', async () => {
            const url = document.getElementById('playlist-url').value.trim();
            if (!url) {
                showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø· Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ´ØºÙŠÙ„.');
                return;
            }

            try {
                const response = await fetch('/playlist_info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url })
                });

                const data = await response.json();
                if (response.ok) {
                    displayPlaylistInfo(data);
                } else {
                    showError(data.error || 'ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ´ØºÙŠÙ„.');
                }
            } catch (error) {
                showError('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….');
            }
        });

        function displayPlaylistInfo(data) {
            const infoContainer = document.getElementById('playlist-info');
            const videosContainer = document.getElementById('playlist-videos');
            
            infoContainer.style.display = 'block';
            videosContainer.style.display = 'block';
            
            infoContainer.innerHTML = `
                <h3>${data.playlist_title}</h3>
                <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª:</strong> ${data.total_videos}</p>
                <button id="download-all-playlist" class="download-all-btn">ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</button>
            `;
            
            videosContainer.innerHTML = '';
            data.videos.forEach((video, index) => {
                const videoItem = document.createElement('div');
                videoItem.className = 'playlist-video-item';
                videoItem.innerHTML = `
                    <div class="video-thumbnail-small">
                        <img src="${video.thumbnail}" alt="ØµÙˆØ±Ø© Ù…ØµØºØ±Ø©" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjkwIiB2aWV3Qm94PSIwIDAgMTIwIDkwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iOTAiIGZpbGw9IiNlZWUiLz48dGV4dCB4PSI2MCIgeT0iNDUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMiIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø©</dGV4dD48L3N2Zz4='">
                    </div>
                    <div class="video-info-small">
                        <h4>${video.title}</h4>
                        <p>Ø§Ù„Ù…Ø¯Ø©: ${formatDuration(video.duration)}</p>
                        <button class="btn-small" onclick="downloadSingleFromPlaylist('${video.url}', '${video.title}')">ØªØ­Ù…ÙŠÙ„</button>
                    </div>
                `;
                videosContainer.appendChild(videoItem);
            });
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª
            document.getElementById('download-all-playlist').addEventListener('click', () => {
                const urls = data.videos.map(video => video.url);
                downloadPlaylistBatch(urls);
            });
        }

        function formatDuration(seconds) {
            if (!seconds || seconds === 0) return 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function downloadSingleFromPlaylist(url, title) {
            // ÙØªØ­ ØµÙØ­Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ÙØ±Ø¯ÙŠ
            window.open(`/?url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}`, '_blank');
        }

        function downloadPlaylistBatch(urls) {
            // Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ù…ØªØ¹Ø¯Ø¯ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
            fetch('/batch_download', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ urls: urls })
            })
            .then(response => response.json())
            .then(data => {
                if (data.batch_id) {
                    startProgressTracking(data.batch_id);
                    showNotification(`ØªÙ… Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ ${urls.length} ÙÙŠØ¯ÙŠÙˆ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©`, 'info');
                }
            })
            .catch(error => {
                showError('ÙØ´Ù„ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯');
            });
        }

        // --- Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ ---
        document.getElementById('batch-fetch-btn').addEventListener('click', async () => {
            const urlsText = document.getElementById('batch-urls').value.trim();
            if (!urlsText) {
                showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±ÙˆØ§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨.');
                return;
            }

            const urls = urlsText.split('\n').filter(url => url.trim());
            if (urls.length === 0) {
                showError('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±ÙˆØ§Ø¨Ø· ØµØ§Ù„Ø­Ø©.');
                return;
            }

            try {
                const response = await fetch('/batch_download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ urls: urls })
                });

                const data = await response.json();
                if (response.ok) {
                    startProgressTracking(data.batch_id);
                    showBatchResults(data);
                } else {
                    showError(data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯.');
                }
            } catch (error) {
                showError('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….');
            }
        });

        // --- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ---
        document.getElementById('save-settings').addEventListener('click', saveSettings);
        document.getElementById('reset-settings').addEventListener('click', resetSettings);
        document.getElementById('export-settings').addEventListener('click', exportSettings);
        document.getElementById('import-settings').addEventListener('click', importSettings);
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØªØ¨ÙˆÙŠØ¨
        document.querySelector('[data-tab="settings"]').addEventListener('click', loadSettings);

        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('appSettings') || '{}');
            
            document.getElementById('max-concurrent').value = settings.maxConcurrent || 2;
            document.getElementById('default-quality').value = settings.defaultQuality || 'best';
            document.getElementById('download-path').value = settings.downloadPath || '';
            document.getElementById('auto-dark-mode').checked = settings.autoDarkMode || false;
            document.getElementById('show-notifications').checked = settings.showNotifications !== false;
            document.getElementById('save-history').checked = settings.saveHistory !== false;
            document.getElementById('user-agent').value = settings.userAgent || '';
            document.getElementById('proxy').value = settings.proxy || '';
        }

        function saveSettings() {
            const settings = {
                maxConcurrent: parseInt(document.getElementById('max-concurrent').value),
                defaultQuality: document.getElementById('default-quality').value,
                downloadPath: document.getElementById('download-path').value,
                autoDarkMode: document.getElementById('auto-dark-mode').checked,
                showNotifications: document.getElementById('show-notifications').checked,
                saveHistory: document.getElementById('save-history').checked,
                userAgent: document.getElementById('user-agent').value,
                proxy: document.getElementById('proxy').value
            };
            
            localStorage.setItem('appSettings', JSON.stringify(settings));
            showNotification('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!', 'success');
        }

        function resetSettings() {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªØŸ')) {
                localStorage.removeItem('appSettings');
                loadSettings();
                showNotification('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 'info');
            }
        }

        function exportSettings() {
            const settings = localStorage.getItem('appSettings') || '{}';
            const blob = new Blob([settings], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'youtube-downloader-settings.json';
            a.click();
            URL.revokeObjectURL(url);
            showNotification('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 'success');
        }

        function importSettings() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const settings = JSON.parse(e.target.result);
                            localStorage.setItem('appSettings', JSON.stringify(settings));
                            loadSettings();
                            showNotification('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                        } catch (error) {
                            showError('Ø®Ø·Ø£ ÙÙŠ Ù…Ù„Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // --- ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§Ø±ÙŠØ® ---
        document.getElementById('refresh-history').addEventListener('click', loadHistory);
        document.getElementById('clear-history').addEventListener('click', clearHistory);
        document.getElementById('health-check').addEventListener('click', performHealthCheck);

        function clearHistory() {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§ØªØŸ')) {
                fetch('/clear_history', { method: 'POST' })
                    .then(() => {
                        loadHistory();
                        showNotification('ØªÙ… Ù…Ø³Ø­ Ø§Ù„ØªØ§Ø±ÙŠØ®', 'info');
                    })
                    .catch(error => {
                        showError('ÙØ´Ù„ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„ØªØ§Ø±ÙŠØ®');
                    });
            }
        }

        function performHealthCheck() {
            fetch('/health')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'healthy') {
                        showNotification(`âœ… ${data.message} - yt-dlp: ${data.yt_dlp_version}`, 'success');
                    } else {
                        showError(`âŒ ${data.message}`);
                    }
                })
                .catch(error => {
                    showError('ÙØ´Ù„ ÙÙŠ ÙØ­Øµ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚');
                });
        }

        function loadHistory() {
            fetch('/history')
                .then(response => response.json())
                .then(history => {
                    displayHistory(history);
                })
                .catch(error => {
                    console.error('Error loading history:', error);
                });
        }

        function displayHistory(history) {
            const container = document.getElementById('history-list');
            container.innerHTML = '';

            if (history.length === 0) {
                container.innerHTML = '<p class="note">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ§Ø±ÙŠØ® ØªØ­Ù…ÙŠÙ„Ø§Øª.</p>';
                return;
            }

            history.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div class="history-info">
                        <h4>${item.title}</h4>
                        <p><strong>Ø§Ù„Ø¬ÙˆØ¯Ø©:</strong> ${item.quality}</p>
                        <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${new Date(item.timestamp).toLocaleString('ar-SA')}</p>
                        <p><strong>Ø§Ù„Ø­Ø¬Ù…:</strong> ${(item.size / 1024 / 1024).toFixed(2)} MB</p>
                    </div>
                    <div class="history-actions">
                        <button class="btn-small" onclick="window.open('${item.url}', '_blank')">Ø¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</button>
                    </div>
                `;
                container.appendChild(historyItem);
            });
        }

        function showBatchResults(data) {
            const container = document.getElementById('batch-results');
            container.style.display = 'block';
            container.innerHTML = `
                <h3>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯</h3>
                <p>ØªÙ… Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ ${data.total} ÙÙŠØ¯ÙŠÙˆ</p>
                <div id="batch-progress"></div>
            `;
        }

        function startProgressTracking(downloadId) {
            if (progressInterval) {
                clearInterval(progressInterval);
            }

            progressInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/progress/${downloadId}`);
                    const progress = await response.json();
                    
                    updateProgressBar(progress);
                    
                    if (progress.status === 'completed' || progress.status === 'error') {
                        clearInterval(progressInterval);
                        if (progress.status === 'completed') {
                            showNotification('ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                        } else {
                            showError(progress.message);
                        }
                    }
                } catch (error) {
                    console.error('Error tracking progress:', error);
                }
            }, 1000);
        }

        function updateProgressBar(progress) {
            const container = document.getElementById('progress-container');
            const fill = document.getElementById('progress-fill');
            const text = document.getElementById('progress-text');
            const message = document.getElementById('progress-message');

            container.style.display = 'block';
            fill.style.width = progress.progress + '%';
            text.textContent = progress.progress + '%';
            message.textContent = progress.message;
        }

        function showNotification(message, type = 'info') {
            // Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø´Ø¹Ø§Ø±
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        fetchBtn.addEventListener('click', async () => {
            const url = urlInput.value.trim();
            if (!url) {
                showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨.');
                return;
            }

            videoInfoContainer.style.display = 'none';
            errorMessage.style.display = 'none';
            loader.style.display = 'block';

            try {
                const response = await fetch('/get_video_info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url }),
                });

                const data = await response.json();
                loader.style.display = 'none';

                if (response.ok) {
                    displayVideoInfo(data, url);
                } else {
                    showError(data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ.');
                }

            } catch (error) {
                showError('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                loader.style.display = 'none';
            }
        });

        function displayVideoInfo(data, videoUrl) {
            currentVideoUrl = videoUrl;
            currentVideoTitle = data.video_info.title;

            document.getElementById('video-thumbnail').src = data.video_info.thumbnail_url;
            document.getElementById('video-title').textContent = data.video_info.title;
            document.getElementById('video-duration').textContent = data.video_info.duration;

            const { video_audio, video_only, audio_only } = data.streams;

            populateStreams('video-audio-streams', video_audio, false);
            populateStreams('video-only-streams', video_only, false);
            populateStreams('audio-only-streams', audio_only, true);

            document.getElementById('video-audio-section').style.display = video_audio.length > 0 ? 'block' : 'none';
            document.getElementById('video-only-section').style.display = video_only.length > 0 ? 'block' : 'none';
            document.getElementById('audio-only-section').style.display = audio_only.length > 0 ? 'block' : 'none';

            videoInfoContainer.style.display = 'flex';
        }

        function populateStreams(containerId, streams, isAudio) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            if (streams.length > 0) {
                streams.forEach(stream => {
                    const text = isAudio ?
                        `${stream.ext.toUpperCase()} - ${stream.filesize}` :
                        `${stream.resolution} (${stream.ext.toUpperCase()}) - ${stream.filesize}`;
                    const downloadLink = createDownloadButton(stream.itag, text, isAudio);
                    container.appendChild(downloadLink);
                });
            } else {
                container.innerHTML = '<p class="note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®ÙŠØ§Ø±Ø§Øª Ù…ØªØ§Ø­Ø© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©.</p>';
            }
        }
        
        function createDownloadButton(itag, text, isAudio) {
            const button = document.createElement('a');
            button.className = 'download-btn';
            const downloadId = generateDownloadId();
            let href = `/download?url=${encodeURIComponent(currentVideoUrl)}&itag=${itag}&title=${encodeURIComponent(currentVideoTitle)}&download_id=${downloadId}`;
            if (isAudio) {
                href += '&is_audio=true';
            }
            
            button.href = href;
            button.textContent = text;
            button.target = '_blank';
            
            // Ø¥Ø¶Ø§ÙØ© ØªØªØ¨Ø¹ Ø§Ù„ØªÙ‚Ø¯Ù…
            button.addEventListener('click', () => {
                startProgressTracking(downloadId);
                addToActiveDownloads(downloadId, currentVideoTitle, text);
            });
            
            return button;
        }

        function generateDownloadId() {
            return 'download_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function addToActiveDownloads(downloadId, title, quality) {
            const container = document.getElementById('active-downloads');
            const list = document.getElementById('downloads-list');
            
            container.style.display = 'block';
            
            const downloadItem = document.createElement('div');
            downloadItem.className = 'download-item';
            downloadItem.id = `download-${downloadId}`;
            downloadItem.innerHTML = `
                <div class="download-info">
                    <h4>${title}</h4>
                    <p>${quality}</p>
                </div>
                <div class="download-status">
                    <div class="mini-progress-bar">
                        <div class="mini-progress-fill" id="mini-progress-${downloadId}"></div>
                    </div>
                    <span class="download-percentage" id="mini-percentage-${downloadId}">0%</span>
                </div>
            `;
            
            list.appendChild(downloadItem);
            activeDownloads.set(downloadId, downloadItem);
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            videoInfoContainer.style.display = 'none';
        }
    </script>

</body>
</html>

